{% extends "base.html" %}

{% block title %}{% if post %}Edit Research{% else %}New Research{% endif %} - the-planet-mars.org{% endblock %}

{% block head %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
{% endblock %}

{% block content %}
<section class="editor-page container">
    <header class="editor-header">
        <h1>{% if post %}Modify Log Entry{% else %}Initialize New Research{% endif %}</h1>
        <a href="/admin" class="text-dim">Cancel</a>
    </header>

    <form id="post-form" action="{% if post %}/admin/post/edit/{{ post.id }}{% else %}/admin/post/new{% endif %}"
        method="POST">
        <div class="language-tabs">
            <button type="button" class="tab-btn active" data-lang="en">English (Base)</button>
            <button type="button" class="tab-btn" data-lang="it">Italiano (Optional)</button>
        </div>

        <div class="lang-section en-section">
            <div class="form-group">
                <label for="title">English Title</label>
                <input type="text" name="title" id="title" value="{{ post.title if post else '' }}" required
                    placeholder="e.g. Discovery of Brine in Gale Crater">
            </div>
        </div>

        <div class="lang-section it-section" style="display: none;">
            <div class="form-group">
                <label for="title_it">Italian Title (Fallback to English if empty)</label>
                <input type="text" name="title_it" id="title_it" value="{{ post.title_it if post else '' }}"
                    placeholder="e.g. Scoperta di salamoia nel cratere Gale">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group flex-2">
                <label for="media_url">Media URL (Image or Video)</label>
                <div class="input-with-button">
                    <input type="text" name="media_url" id="media_url" value="{{ post.media_url if post else '' }}"
                        placeholder="https://...">
                    <button type="button" id="upload-btn" class="btn btn-secondary btn-sm">Upload Media</button>
                    <input type="file" id="media-file" style="display: none;" accept="image/*,video/*">
                </div>
                <div id="upload-progress" style="display: none; margin-top: 0.5rem;">
                    <progress id="progress-bar" value="0" max="100" style="width: 100%; height: 10px;"></progress>
                    <small id="progress-text" class="text-dim">Uploading...</small>
                </div>
            </div>
            <div class="form-group flex-1">
                <label for="media_type">Media Type</label>
                <select name="media_type" id="media_type">
                    <option value="image" {% if post and post.media_type=='image' %}selected{% endif %}>Image</option>
                    <option value="video" {% if post and post.media_type=='video' %}selected{% endif %}>Video</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label id="editor-label">Research Content (English)</label>
            <div id="editor-container" style="height: 400px; background: white; color: black; border-radius: 8px;">
                {{ post.content|safe if post else '' }}
            </div>
            <input type="hidden" name="content" id="content-input" value="{{ post.content if post else '' }}">
            <input type="hidden" name="content_it" id="content-it-input" value="{{ post.content_it if post else '' }}">
        </div>

        <div class="editor-footer">
            <button type="submit" name="status" value="draft" class="btn btn-secondary">Save Draft</button>
            <button type="submit" name="status" value="published" class="btn btn-primary">Publish to Surface</button>
        </div>
    </form>
</section>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    var quill = new Quill('#editor-container', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'link'],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                ['clean']
            ]
        }
    });

    const contentInput = document.getElementById('content-input');
    const contentItInput = document.getElementById('content-it-input');
    let currentLang = 'en';

    // Tab Switching Logic
    const tabs = document.querySelectorAll('.tab-btn');
    const sections = {
        en: document.querySelector('.en-section'),
        it: document.querySelector('.it-section')
    };
    const editorLabel = document.getElementById('editor-label');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            // Save current editor content before switching
            if (currentLang === 'en') {
                contentInput.value = quill.root.innerHTML;
            } else {
                contentItInput.value = quill.root.innerHTML;
            }

            // Switch active tab UI
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            // Switch visibility
            const nextLang = tab.dataset.lang;
            sections[currentLang].style.display = 'none';
            sections[nextLang].style.display = 'block';

            // Update editor content
            currentLang = nextLang;
            editorLabel.textContent = `Research Content (${currentLang === 'en' ? 'English' : 'Italian'})`;
            quill.root.innerHTML = currentLang === 'en' ? contentInput.value : contentItInput.value;
        });
    });

    var form = document.getElementById('post-form');
    form.onsubmit = function () {
        // Final sync of current language
        if (currentLang === 'en') {
            contentInput.value = quill.root.innerHTML;
        } else {
            contentItInput.value = quill.root.innerHTML;
        }
        return true;
    };

    // Media Upload Logic
    const uploadBtn = document.getElementById('upload-btn');
    const mediaFile = document.getElementById('media-file');
    const mediaUrlInput = document.getElementById('media_url');
    const mediaTypeSelect = document.getElementById('media_type');
    const uploadProgress = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');

    uploadBtn.addEventListener('click', () => mediaFile.click());

    mediaFile.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        uploadProgress.style.display = 'block';
        uploadBtn.disabled = true;
        progressText.textContent = "Requesting signed URL...";
        progressBar.value = 0;

        try {
            // 1. Get Signed URL from Backend
            const response = await fetch('/admin/api/signed-url', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    filename: file.name,
                    content_type: file.type
                })
            });

            if (!response.ok) throw new Error("Could not get signed URL");
            const { upload_url, public_url } = await response.json();

            // 2. Upload directly to S3 via PUT
            progressText.textContent = `Uploading ${file.name}...`;
            
            const xhr = new XMLHttpRequest();
            xhr.open('PUT', upload_url, true);
            xhr.setRequestHeader('Content-Type', file.type);
            xhr.setRequestHeader('x-amz-acl', 'public-read');

            xhr.upload.onprogress = (evt) => {
                if (evt.lengthComputable) {
                    const percentComplete = (evt.loaded / evt.total) * 100;
                    progressBar.value = percentComplete;
                }
            };

            xhr.onload = () => {
                if (xhr.status === 200) {
                    mediaUrlInput.value = public_url;
                    mediaTypeSelect.value = file.type.startsWith('image/') ? 'image' : 'video';
                    progressText.textContent = "Upload successful!";
                    setTimeout(() => uploadProgress.style.display = 'none', 2000);
                } else {
                    throw new Error("S3 Upload failed");
                }
                uploadBtn.disabled = false;
            };

            xhr.onerror = () => {
                throw new Error("Network error during upload");
            };

            xhr.send(file);

        } catch (err) {
            console.error(err);
            progressText.textContent = `Error: ${err.message}`;
            uploadBtn.disabled = false;
        }
    });
</script>

<style>
    .editor-page {
        padding: 5rem 2rem;
    }

    .editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 3rem;
    }

    .editor-header h1 {
        font-family: 'Playfair Display', serif;
        color: var(--mars-orange);
    }

    .form-group {
        margin-bottom: 2rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-dim);
        font-size: 0.8rem;
        text-transform: uppercase;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        background: var(--crater-gray);
        border: 1px solid #333;
        padding: 1rem;
        color: white;
        border-radius: 8px;
    }

    .form-row {
        display: flex;
        gap: 2rem;
    }

    .flex-1 {
        flex: 1;
    }

    .flex-2 {
        flex: 2;
    }

    .editor-footer {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 3rem;
    }

    .language-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        border-bottom: 1px solid #333;
        padding-bottom: 1rem;
    }

    .tab-btn {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid #333;
        color: var(--text-dim);
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.8rem;
        transition: all 0.3s;
    }

    .tab-btn.active {
        background: var(--mars-orange);
        color: var(--space-black);
        border-color: var(--mars-orange);
    }

    .input-with-button {
        display: flex;
        gap: 0.5rem;
    }

    .btn-sm {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
        white-space: nowrap;
    }

    .text-dim {
        color: var(--text-dim);
        text-decoration: none;
    }
</style>
{% endblock %}